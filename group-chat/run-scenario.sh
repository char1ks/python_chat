#!/bin/bash

SCENARIO=${1:-1}

echo "üé≠ –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è $SCENARIO —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.scenario-1.yml down 2>/dev/null
docker-compose -f docker-compose.scenario-3.yml down 2>/dev/null
docker-compose -f docker-compose.scenario-5.yml down 2>/dev/null

case $SCENARIO in
    1)
        echo "üìò –°–¶–ï–ù–ê–†–ò–ô 1: –û–¥–∏–Ω –±—ç–∫—ç–Ω–¥, –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å"
        echo "   - –û–¥–∏–Ω backend —Å–µ—Ä–≤–∏—Å"
        echo "   - Nginx –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫"
        echo "   - –ò—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏"
        echo "   - –ù–ï–¢ Redis"
        docker-compose -f docker-compose.scenario-1.yml up -d
        ;;
    2)
        echo "üí• –°–¶–ï–ù–ê–†–ò–ô 2: –ò–º–∏—Ç–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è –±—ç–∫—ç–Ω–¥–∞"
        echo "   –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π 1, –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backend"
        docker-compose -f docker-compose.scenario-1.yml up -d
        echo "‚è∞ –ë—ç–∫—ç–Ω–¥ —É–ø–∞–¥–µ—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥..."
        sleep 30
        echo "üí• –ü–ê–î–ï–ù–ò–ï! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backend1..."
        docker-compose -f docker-compose.scenario-1.yml stop backend1
        echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω! –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π 3"
        ;;
    3)
        echo "üìó –°–¶–ï–ù–ê–†–ò–ô 3: –î–≤–∞ –±—ç–∫—ç–Ω–¥–∞ + sticky sessions + Redis"
        echo "   - –î–≤–∞ backend —Å–µ—Ä–≤–∏—Å–∞"
        echo "   - Sticky sessions –ø–æ IP hash"
        echo "   - Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏"
        echo "   - –ö–∞–∂–¥—ã–π backend –∞–ø–ø–µ–Ω–¥–∏—Ç —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"
        docker-compose -f docker-compose.scenario-3.yml up -d
        ;;
    4)
        echo "üí•üí• –°–¶–ï–ù–ê–†–ò–ô 4: –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è"
        echo "   –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π 3, –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë"
        docker-compose -f docker-compose.scenario-3.yml up -d
        echo "‚è∞ –ü–æ–ª–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥..."
        sleep 30
        echo "üí•üí• –ü–û–õ–ù–û–ï –ü–ê–î–ï–ù–ò–ï! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
        docker-compose -f docker-compose.scenario-3.yml down
        echo "‚ùå –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞! –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π 5"
        ;;
    5)
        echo "üìô –°–¶–ï–ù–ê–†–ò–ô 5: –ö–ª–∞—Å—Ç–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω + –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ chat_id"
        echo "   - –î–≤–∞ backend —Å–µ—Ä–≤–∏—Å–∞"
        echo "   - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ chat_id (–≤—Å–µ –≤ —á–∞—Ç 1)"
        echo "   - Redis –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏"
        echo "   - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
        docker-compose -f docker-compose.scenario-5.yml up -d
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: $SCENARIO"
        echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: 1, 2, 3, 4, 5"
        exit 1
        ;;
esac

if [ "$SCENARIO" != "2" ] && [ "$SCENARIO" != "4" ]; then
    echo ""
    echo "‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π $SCENARIO –∑–∞–ø—É—â–µ–Ω!"
    echo "üåê –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost"
    echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: docker-compose logs -f"
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./run-scenario.sh stop"
fi 